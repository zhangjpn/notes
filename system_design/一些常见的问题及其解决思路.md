# Q&A

## 设计

### 数据一致性

#### 数据库与缓存的更新一致性问题

并发请求下，如何保证缓存与数据库更新的一致性？

例如：后台管理系统更新配置，需要同时更新到redis缓存和数据库mysql；APP端的请求会先访问redis缓存，如果缓存未命中，则从数据库获取数据，并更新缓存。

思路：这个场景下持久性优于一致性，写入mysql是必须完成的，其次是redis和mysql的一致性。可以确定的是，此处必定存在不一致的时间段，至于这个时间段能否尽量缩小至可以忽略的地步，取决于业务。

方案：

1. 访问redis数据，但并不直接更新数据，而是给该缓存设置一个时间不长的过期时间
2. 访问mysql，并写入数据
3. 再次访问redis，此时更新缓存数据

故障：
若第一步出现故障，整个操作终止，redis可能更新，对其它访问缓存者而言无感知；
若第二步故障，mysql未写入，缓存也未更新
若第三部故障，mysql写入，缓存未更新，此时开始出现不一致，不一致状态的修复是通过第一步设置的过期时间来自动触发缓存更新，因此不一致的时间段是这个过期时长。
