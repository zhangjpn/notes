# 核心概念

用户
PG命令行工具可使用PGUSER环境变量指定登录用户名

```shell
/usr/local/pgsql/bin/createdb mydb
/usr/local/pgsql/bin/dropdb mydb

$ psql mydb

```

internal commands

https://www.postgresql.org/docs/11/app-psql.html


```psql

mydb=> \h  
mydb=> \q  # 退出
mydb=> \?  # 帮助
mydb=> \i basics.sql # read commands

```

DDL:

standard SQL types int, smallint, real, double precision, char(N), varchar(N), date, time, timestamp, and interval

```sql
CREATE TABLE weather (
    city            varchar(80),
    temp_lo         int,           -- low temperature
    temp_hi         int,           -- high temperature
    prcp            real,          -- precipitation
    date            date
);
CREATE TABLE cities (
    name            varchar(80),
    location        point  -- 自定义类型
);
DROP TABLE tablename;


INSERT INTO cities VALUES ('San Francisco', '(-194.0, 53.0)');
INSERT INTO weather (city, temp_lo, temp_hi, prcp, date)
    VALUES ('San Francisco', 43, 57, 0.0, '1994-11-29');


COPY weather FROM '/home/user/weather.txt';  -- 从文件中批量执行SQL  https://www.postgresql.org/docs/11/sql-copy.html

SELECT * FROM weather;
SELECT city, (temp_hi+temp_lo)/2 AS temp_avg, date FROM weather;
SELECT * FROM weather
    WHERE city = 'San Francisco' AND prcp > 0.0;
SELECT * FROM weather
    ORDER BY city;

SELECT DISTINCT city
    FROM weather;
SELECT DISTINCT city
    FROM weather
    ORDER BY city;

SELECT city, temp_lo, temp_hi, prcp, date, location
    FROM weather, cities
    WHERE city = name;  -- 不用join on，而是在where实现列的指定
SELECT *
    FROM weather INNER JOIN cities ON (weather.city = cities.name);

SELECT *
    FROM weather LEFT OUTER JOIN cities ON (weather.city = cities.name);
SELECT *
    FROM weather w, cities c
    WHERE w.city = c.name;



-- aggregate functions

SELECT city, count(*), max(temp_lo)
    FROM weather
    GROUP BY city;


SELECT city, count(*), max(temp_lo)
    FROM weather
    GROUP BY city
    HAVING max(temp_lo) < 40;  -- 聚类筛选

SELECT city, 
count(*) FILTER (WHERE temp_lo < 45), -- 在每个分组下做进一步筛选filter
max(temp_lo)
    FROM weather
    GROUP BY city;


UPDATE weather
    SET temp_hi = temp_hi - 2,  temp_lo = temp_lo - 2
    WHERE date > '1994-11-28';
DELETE FROM weather WHERE city = 'Hayward';


-- view 视图
CREATE VIEW myview AS
    SELECT name, temp_lo, temp_hi, prcp, date, location
        FROM weather, cities
        WHERE city = name;


CREATE TABLE cities (
        name     varchar(80) primary key,
        location point
);

CREATE TABLE weather (
        city      varchar(80) references cities(name),  -- 外键
        temp_lo   int,
        temp_hi   int,
        prcp      real,
        date      date
);

BEGIN;
UPDATE accounts SET balance = balance - 100.00
    WHERE name = 'Alice';
-- etc etc
COMMIT;

BEGIN;
UPDATE accounts SET balance = balance - 100.00
    WHERE name = 'Alice';
SAVEPOINT my_savepoint;
UPDATE accounts SET balance = balance + 100.00
    WHERE name = 'Bob';
-- oops ... forget that and use Wally's account
ROLLBACK TO my_savepoint;
UPDATE accounts SET balance = balance + 100.00
    WHERE name = 'Wally';
COMMIT;

-- https://www.postgresql.org/docs/11/tutorial-window.html 窗口函数 over ... partition by ...
-- https://www.postgresql.org/docs/11/tutorial-inheritance.html 表继承

```

## 语法

- key word: CRUD
- identifier /quoted identifier ("abc")
- constant: strings, bit strings, and numbers
  - 'string'
  - bit string: B'1001', X'1FF'
  - numbers: 

类型转换

```sql
type 'string'
'string'::type
CAST ( 'string' AS type )
typename ( 'string' )
```


## 如何使用索引

B-tree, Hash, GiST, SP-GiST, GIN, BRIN, and the extension bloom

```sql

CREATE INDEX test1_id_index ON test1 (id);
CREATE INDEX name ON table USING HASH (column);


-- partial index
CREATE INDEX access_log_client_ip_ix ON access_log (client_ip)
WHERE NOT (client_ip > inet '192.168.100.0' AND
           client_ip < inet '192.168.100.255');
```

[] 如何改造以适合bytea的数据类型？
[] 是什么内容导致索引构造失败？

CREATE INDEX idx_xcom_value ON xcom (value) WHERE task_id = 'prepare_conf';
